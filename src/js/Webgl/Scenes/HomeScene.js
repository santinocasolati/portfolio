import * as THREE from 'three';
import { gsap } from 'gsap';

export class HomeScene {
    constructor(textureLoader, gui) {
        this.textureLoader = textureLoader;
        this.gui = gui;

        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color("#0f0f0f");

        this.width = window.innerWidth;
        this.height = window.outerHeight;

        this.camera = new THREE.PerspectiveCamera(80, this.width / this.height, 100, 1000);
        this.camera.position.z = 1000;
        this.scene.add(this.camera);

        this.portalParticles = [];
        this.smokeParticles = [];
        this.tempColor = { value: "#062d89" };

        this.init();
    }

    init() {
        this.addLights();

        this.particleSetup();

        this.setDebug();

        this.setupResize();
        this.resize();
    }

    setDebug() {
        const debugObject = {
            portalColor: "#062D89",
            start: false
        }

        const portalSettings = this.gui.addFolder("Portal");

        portalSettings.addColor(debugObject, 'portalColor').onChange(() => {
            this.changeLightColor(debugObject.portalColor);
        });

        portalSettings.add(debugObject, 'start').onChange(() => {
            this.start = debugObject.start
        });
    }

    addLights() {
        const sceneLight = new THREE.DirectionalLight(0xffffff, 0.5);
        sceneLight.position.set(0, 0, 1);
        this.scene.add(sceneLight);

        this.portalLight = new THREE.PointLight('#062d89', 30, 350, 1.7);
        this.portalLight.position.set(0, 100, 250);
        this.scene.add(this.portalLight);
    }

    particleSetup() {
        const random = [
            0.6933043941409995,
            0.5273823548492913,
            0.8003017478568983,
            0.38290832131052555,
            0.3645847880250812,
            0.054090606349354475,
            0.14881862496186837,
            0.7460697874812547,
            0.5384350562714748,
            0.24014307595069817,
            0.286917164669545,
            0.18143746759978252,
            0.8414033297850969,
            0.24429055425856094,
            0.1650330237978821,
            0.1064116084516753,
            0.5841170606740103,
            0.31202341201957107,
            0.3528869445407672,
            0.7310694953562182,
            0.11944469545309411,
            0.4554570432765839,
            0.5387655500093034,
            0.11659377973351526,
            0.38985091183142506,
            0.5159395388697661,
            0.1415197774357133,
            0.6727479107274328,
            0.6732821029921994,
            0.5309310637583684,
            0.8853900846481868,
            0.12623837369900182,
            0.5781342091181232,
            0.6217030407071253,
            0.06743919022907141,
            0.5894578345141375,
            0.9896452931460582,
            0.09617399677648031,
            0.44843732455460383,
            0.7245663670065428,
            0.3363922635013692,
            0.10236601648918708,
            0.9002336192614919,
            0.222601217358801,
            0.9643786589932022,
            0.794498171776179,
            0.5208831013225166,
            0.28227726723787194,
            0.8806902094625317,
            0.22608522723886537,
            0.8928878874642774,
            0.8469547861149509,
            0.6917893097997472,
            0.40089975195677474,
            0.06364430487865769,
            0.7782328932986775,
            0.3343121850199624,
            0.7470730258635778,
            0.6717964379964358,
            0.754024885710407,
            0.9992966103929026,
            0.6555906404779794,
            0.9938023972386367,
            0.21847425262798104,
            0.44312955164097034,
            0.9882062524541828,
            0.3495627186934389,
            0.16916167536003313,
            0.4339461479194151,
            0.4140665036586435,
            0.7875926319952729,
            0.9576952723529648,
            0.6021427724084554,
            0.8936946807092072,
            0.22741588342077423,
            0.8578289624659761,
            0.12957095939137142,
            0.47267822538626225,
            0.9702873064420305,
            0.17697205086842316,
            0.21295327952671372,
            0.38547624867208663,
            0.8769640382933266,
            0.44621286318488873,
            0.7973965011028432,
            0.7011691768978261,
            0.005651652126146045,
            0.027238207219247412,
            0.6188155238155777,
            0.32357247100204334,
            0.32770152954367227,
            0.7440096504815932,
            0.9488424124221,
            0.9244279113862752,
            0.4136444941406565,
            0.44956597955969846,
            0.6798759816293165,
            0.3382695944259415,
            0.14055794752535067,
            0.9515052217160669,
            0.8509096494998305,
            0.4641544229138739,
            0.40830045878529897,
            0.7987197197219433,
            0.3117763532998703,
            0.09826278728720572,
            0.8567578035591501,
            0.04008880266114745,
            0.47486857519913084,
            0.6622891916979179,
            0.952022786259662,
            0.7021290162901668,
            0.5610945714361713,
            0.9190869940249888,
            0.03794742693064812,
            0.22676121108179825,
            0.9175312648007938,
            0.7829169245196854,
            0.006639247868754694,
            0.7281236314403485,
            0.3464447152307195,
            0.33644410823870374,
            0.4679174522163345,
            0.15089919822447628,
            0.21706810795280562,
            0.5506472184980105,
            0.7571072970994717,
            0.33734885789596447,
            0.0715711724494581,
            0.2553623254084032,
            0.44540140797750705,
            0.9799988235270716,
            0.3348200942250721,
            0.15054227925931363,
            0.8546064142187368,
            0.7921243845891732,
            0.5540594150394638,
            0.16546364323176022,
            0.6833107209077036,
            0.3096460507010683,
            0.5259279666402434,
            0.557360092422519,
            0.606234922084588,
            0.7097358390011994,
            0.7493241651471223,
            0.6257909843388265,
            0.522584844663877,
            0.5809614230785025,
            0.7328213728231088,
            0.9169093010151981,
            0.1766072375297445,
            0.13627837268472032,
            0.9862755114115316,
            0.372125362017079,
            0.13931423552670852,
            0.9404233080681261,
            0.011697182052863964,
            0.5187245250674064,
            0.9449447385594107,
            0.2198512513367752,
            0.6339553539525187,
            0.7391718626980748,
            0.5338911008895217,
            0.14951103808753707,
            0.9297312330560741,
            0.32055903716464784,
            0.7916463324720058,
            0.11580916103177419,
            0.0958919450889808,
            0.10730788272926906,
            0.10645487891833394,
            0.10260017347263184,
            0.5196840753135636,
            0.8518085809078082,
            0.5560281943033487,
            0.3459788268584294,
            0.31534565368209844,
            0.6578991964516443,
            0.6172909521536492,
            0.5766075241662396,
            0.5580110437959978,
            0.16920533311002184,
            0.179055240681802,
            0.27689299503920806,
            0.10797069222078703,
            0.7583174669003108,
            0.2618973910530733,
            0.23723120776189877,
            0.7592775081267593,
            0.8760279259513741,
            0.027995688959199683,
            0.638505989770848,
            0.5845524392345554,
            0.10362274658695925,
            0.2487689279374452,
            0.4346743862790008,
            0.4346112581475128,
            0.13425765103753462,
            0.07778144555152089,
            0.7077669877490611,
            0.16393558042839507,
            0.7729562802961687,
            0.9057827089292794,
            0.9012100361905331,
            0.7948359270336531,
            0.9398890153425439,
            0.3301453607578868,
            0.6224582262525402,
            0.6784947988081667,
            0.7683582247890419,
            0.9670494683618309,
            0.7583483607008497,
            0.7125987937998679,
            0.9635248567861183,
            0.43652809305289253,
            0.00933949722262728,
            0.08275778732260575,
            0.40854067190442667,
            0.6569656135435229,
            0.12575974498154308,
            0.656948803104829,
            0.37838162897030214,
            0.9383558259614626,
            0.7138349562329636,
            0.2462383700784907,
            0.7014242853377166,
            0.21561277995949935,
            0.45475097027048306,
            0.7300974115675294,
            0.256944313812528,
            0.9493153921278323,
            0.7519912526638635,
            0.23961188575134873,
            0.9960570448758785,
            0.7669602862239957,
            0.07022428228574751,
            0.8693474996447719,
            0.27696928671353493,
            0.059435039884182084,
            0.4052512595064688,
            0.18961803519447185,
            0.22806191108343943,
            0.5686434885784379,
            0.49272936001327716,
            0.28566770583188195,
            0.42642516910287687,
            0.19558875915037222,
            0.9460135373904253,
            0.6763702350043674,
            0.9834687625947209,
            0.9065527880059017,
            0.21377311664771748,
            0.33293304059903694,
            0.9932711023254739,
            0.8974354675724772,
            0.5247575682457719,
            0.6832265461936524,
            0.9976406366987172,
            0.7950847210939109,
            0.7882443637518766,
            0.07701384151975676,
            0.7314453172813498,
            0.32863675592221364,
            0.9638275211059391,
            0.13690030040549983,
            0.2859612960448594,
            0.27850004506379467,
            0.525791420844298,
            0.9296657410627447,
            0.5543671983681866,
            0.6486253449078803,
            0.34901044819984195,
            0.5034873514467395,
            0.48112368349694923,
            0.790746752405417,
            0.005721516917990721,
            0.8459954353609367,
            0.12527425569218242,
            0.3378352430566085,
            0.10001225294500005,
            0.5316534730931417,
            0.888385679054402,
            0.5658710428940397,
            0.6880752039451419,
            0.83184734182813,
            0.6075213350398765,
            0.24919796239218384,
            0.969758376773306,
            0.48967066927974745,
            0.6412015362986057,
            0.6847978865046127,
            0.5712904722321626,
            0.12750171824858647,
            0.740733889821868,
            0.3959772970617279,
            0.7562484445562072,
            0.5759242050044158,
            0.5541313934589216,
            0.28222950173446115,
            0.5333178474233571,
            0.22111262099009,
            0.054996109149312744,
            0.5829104810366059,
            0.8354296298414479,
            0.7776063571942509,
            0.7645419068284798,
            0.5204725751373007,
            0.059507629831011766,
            0.17657291867726288,
            0.5082215314723477,
            0.6743845626554263,
            0.6181810229897875,
            0.6613909909832005,
            0.9304721183465035,
            0.11217933567345462,
            0.18421723932398515,
            0.4917491137428265,
            0.4228274428663903,
            0.46335299932493834,
            0.7283947545148401,
            0.3090892347397447,
            0.5657690585079675,
            0.8932538629914459,
            0.11553539234025512,
            0.6212780542713332,
            0.8173751023930005,
            0.22895689837962618,
            0.6202750379785296,
            0.046671021954696634,
            0.9277852492435736,
            0.49565199445290364,
            0.04709073288151133,
            0.9807862659974704,
            0.2400484925461681,
            0.32207819636892054,
            0.3756071917375763,
            0.5100272202372023,
            0.5744881507778257,
            0.048920734186096215,
            0.9206123259161327,
            0.11384204777171503,
            0.7451531952511732,
            0.8122391347192071,
            0.5367901038204494,
            0.09031044890476769,
            0.17841810015136939,
            0.6587255425952381,
            0.29429305056028143,
            0.7085459721358591,
            0.927316591286987,
            0.5870419504868465,
            0.9891752736267272,
            0.7716538761081584,
            0.22270244910650216,
            0.6551943468169152,
            0.056883177862742995,
            0.20237455565710682,
            0.14038511000620058,
            0.7895939606826758,
            0.8119882131782692,
            0.710021245151272,
            0.45938882270357717,
            0.2833621677450944,
            0.19105352256268726,
            0.10209662190847202,
            0.1913745425775213,
            0.7608686783675704,
            0.8772731337459705,
            0.0038211353913191193,
            0.10451862503689457,
            0.4322069378765452,
            0.09349827741748484,
            0.3180615752828435,
            0.7998433434949264,
            0.04812733998386687,
            0.8021512604527352,
            0.09641093817213942,
            0.5206054618472857,
            0.9170423912565848,
            0.5279916973815559,
            0.3498963578200147,
            0.907398785135078,
            0.9745505500225871,
            0.4049389125943732,
            0.4542893658305158,
            0.7335458061265399,
            0.36655489040595857,
            0.16102656378679425,
            0.11916553935848917,
            0.42034247662083013,
            0.7608444969804131,
            0.949280251591661,
            0.5288629218820751,
            0.11621384001271173,
            0.720258846269574,
            0.5023211862497645,
            0.4397310907636691,
            0.20158798187558702,
            0.41905437024030157,
            0.29234215034202204,
            0.17778838308791722,
            0.5521357272556626,
            0.5242567386236778,
            0.9905786724697412,
            0.14818768349361777,
            0.8002470661121253,
            0.31665444318288727,
            0.5984131636914296,
            0.5120693034957895,
            0.3661875481878891,
            0.2623178696198274,
            0.8546331679036168,
            0.027101424113366246,
            0.536139677867814,
            0.049562454601066896,
            0.7673013990882365,
            0.7281034359218685,
            0.43942266138597175,
            0.021467163420831215,
            0.2994930761044563,
            0.4494411034356651,
            0.6876735594637431,
            0.2541837712698436,
            0.03894921346758662,
            0.5829149785110515,
            0.2758018575119241,
            0.6353314694308787,
            0.10574709476963573,
            0.10193770069629116,
            0.6080781151170553,
            0.178682789241301,
            0.8779200157030838,
            0.32166648490949323,
            0.6375940176378059,
            0.4289158174450993,
            0.6571750538001386,
            0.06148313605579947,
            0.5576752820448909,
            0.5032504445812744,
            0.9279706398109271,
            0.5914465393555508,
            0.7310103541311495,
            0.6996620901901844,
            0.6888068943441719,
            0.3368869065342659,
            0.6869127783877409,
            0.4902844175935914,
            0.9288387155713678,
            0.8940498408210411,
            0.6457601004911064,
            0.5175941831370812,
            0.5547597530881849,
            0.40555237672512656,
            0.6356798712512857,
            0.5122798785443945,
            0.19769431225209888,
            0.7054026799239563,
            0.4776138643551622,
            0.3128518650803662,
            0.9005961922636907,
            0.1833601014197641,
            0.6170325082651855,
            0.7618833004245209,
            0.20046683769787688,
            0.9025357030915893,
            0.6482575074307464,
            0.6299880922383139,
            0.30754505050507386,
            0.9642904688304514,
            0.8979390076971441,
            0.8097130263592751,
            0.4390136146367767,
            0.8253031492303182,
            0.18229844791611227,
            0.9630840916607684,
            0.412071249051998,
            0.4346505337470594,
            0.22131058998521547,
            0.17080035245850556,
            0.22835794348473915,
            0.6636709453073226,
            0.5663946830495146,
            0.10679335566334403,
            0.454007797494681,
            0.42788913081712043,
            0.6966869212985425,
            0.24156504162024617,
            0.22244819745522348,
            0.6212337625810656,
            0.8562460123531599,
            0.44179794390851823,
            0.3113226482736198,
            0.8348683472963749,
            0.642768641015933,
            0.8427888069886431,
            0.6454152160179529,
            0.10458274032022952,
            0.8736139985098792,
            0.48507595848177143,
            0.6910438457866841,
            0.18458623127163043,
            0.8322822227823627,
            0.22033830749269434,
            0.1786021396293267,
            0.88280802040127,
            0.06367492755650206,
            0.44176092697799785,
            0.7512558824745053,
            0.5687843225751763,
            0.5560308825096265,
            0.8898837005322322,
            0.29074250736530227,
            0.48586931249854337,
            0.1819918483385936,
            0.9375697080964704,
            0.11241275686174212,
            0.0187440701644781,
            0.782653240461096,
            0.5790952402597327,
            0.9169064314852886,
            0.1838672208306933,
            0.589924160212121,
            0.3770367957200558,
            0.16460715013775484,
            0.933748065905476,
            0.5583237655669231,
            0.18761403659851572,
            0.5828653406098012,
            0.6688186005905903,
            0.08133068048004999,
            0.45425763849317047,
            0.5649512639881569,
            0.43105857536582115,
            0.04110137032342531,
            0.6853985212490223,
            0.8074612959058289,
            0.17756239928056883,
            0.7532454390582279,
            0.8099741447774489,
            0.6616350733235419,
            0.7017322256031899,
            0.5916138746658732,
            0.6459360582071367,
            0.13664409606528038,
            0.022784278822926884,
            0.12498646865477503,
            0.2844178976068752,
            0.5523693734131139,
            0.16219743142553256,
            0.18853895567483958,
            0.36087109480917556,
            0.3193360925458606,
            0.5337603896976151,
            0.4480421187770134,
            0.5789009193152481,
            0.9767016353828271,
            0.850189827605335,
            0.8708818737566073,
            0.7089075398585891,
            0.4635083988579787,
            0.752603599713356,
            0.005758664300707039,
            0.21323273116529884,
            0.813377545247576,
            0.3071454837963128,
            0.26872082459558144,
            0.5961403089720778,
            0.01744237112471203,
            0.5149109125625344,
            0.5041025584931851,
            0.3425967421849401,
            0.8846071844992689,
            0.04561156330161342,
            0.8132210396146029,
            0.486416982017831,
            0.5927607925162948,
            0.3166949156661625,
            0.9973963206265708,
            0.04111061012752115,
            0.8172252403192037,
            0.9071098895366934,
            0.6498426284990073,
            0.5208402302228154,
            0.189998687870077,
            0.6323924568709054,
            0.8193982167364815,
            0.9666143564250724,
            0.6243071038810923,
            0.6814602445950189,
            0.5586169433389057,
            0.22139704323347154,
            0.34712406822303854,
            0.6386862888755849,
            0.5557750577931175,
            0.37227375898708104,
            0.4371224964797662,
            0.13487348210362482,
            0.8437560180786512,
            0.5391182154285128,
            0.539205285470097,
            0.49239669983672063,
            0.07369963297978299,
            0.2708892297230885,
            0.7100968276741026,
            0.7065238280724373,
            0.32535907795623875,
            0.45564193090751814,
            0.0031831194888791714,
            0.946514561229105,
            0.4163993532758796,
            0.7225029905627764,
            0.2707394336920148,
            0.751121457678821,
            0.9537426688691526,
            0.5186031650220166,
            0.8612714860454505,
            0.8275836494950208,
            0.07119727293418765,
            0.7072885406130505,
            0.3566241977212674,
            0.9931978725280448,
            0.33185545425189544,
            0.5362404497331772,
            0.8683012154193683,
            0.5749697273535206,
            0.9886879954133607,
            0.6832162017745935,
            0.6262451991326803,
            0.6955150038900861,
            0.15904940697841363
        ]

        this.textureLoader.load("static/textures/smoke.png", (texture) => {
            const portalGeo = new THREE.PlaneGeometry(1, 1);
            const portalMaterial = new THREE.MeshPhongMaterial({
                map: texture,
                transparent: true,
                opacity: 0.4,
                depthTest: false
            });

            const group = new THREE.Group();
            this.scene.add(group)

            let count = 0;

            for (let i = 880; i > 250; i--) {
                const particle = new THREE.Mesh(portalGeo, portalMaterial);
                particle.position.set(
                    0.3 * i * Math.cos((4 * i * Math.PI) / 180),
                    0.3 * i * Math.sin((4 * i * Math.PI) / 180),
                    0.1 * i
                );
                particle.position.y += 100;
                particle.scale.set(350, 350);
                particle.rotation.z = random[count] * 360;
                this.portalParticles.push(particle);
                group.add(particle);

                count++;
            }
        });
    }

    changeLightColor(color) {
        gsap.to(this.tempColor, {
            value: color, duration: 0.3, ease: 'power2.out', onUpdate: () => {
                this.portalLight.color = new THREE.Color(this.tempColor.value);
            }
        });
    }

    resize() {
        setTimeout(() => {
            this.width = window.innerWidth;
            this.height = window.outerHeight;

            this.camera.aspect = this.width / this.height;
            this.camera.updateProjectionMatrix();
        }, 300);
    }

    setupResize() {
        window.addEventListener('resize', this.resize.bind(this));
    }

    update(delta) {
        if (!this.start) {
            return
        }

        if (this.portalParticles[0] && !this.startPoint) {
            this.startPoint = this.portalParticles[0].rotation.z
        }

        if (this.portalParticles[0] && this.portalParticles[0].rotation.z <= this.startPoint - (360 * (Math.PI / 180))) {
            return
        }

        this.portalParticles.forEach(p => {
            p.rotation.z -= delta * 1.5;
        });
    }
}